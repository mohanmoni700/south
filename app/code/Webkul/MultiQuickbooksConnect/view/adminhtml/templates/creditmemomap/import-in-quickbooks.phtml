<?php
/**
 * Webkul Software.
 *
 * @category  Webkul
 * @package   Webkul_MultiQuickbooksConnect
 * @author    Webkul
 * @copyright Copyright (c) Webkul Software Private Limited(https://webkul.com)
 * @license   https://store.webkul.com/license.html
 */

    $creditmemoList = $block->getCreditmemoList();
    $creditmemoCount = $creditmemoList['items_count'];
    $accountId = $creditmemoList['account_id'];
?>
<fieldset class="fieldset">
    <div class="wk-mu-note wk-mu-box">
        <?= /* @noEscape */ __('Starting Execution'); ?>...
    </div>
    <div class="wk-mu-notice wk-mu-box">
        <?= /* @noEscape */ __("Please don't close or refresh the window while exporting credit memo(s)."); ?>
    </div>
    <div class="wk-mu-success wk-mu-box">
        <?= /* @noEscape */ __('Total '); ?>
        <?= /* @noEscape */ $creditmemoCount; ?>
        <?= /* @noEscape */ __(' credit memo(s) to export to Quickbooks'); ?>.
    </div>
    <?php if ($creditmemoCount > 0):?>
        <div class="wk-mu-info-bar">
            <?= /* @noEscape */ __('Export ');?>
            <span class="wk-current">1</span> of <?= /* @noEscape */ $creditmemoCount;?>
            <?php $loaderSrc = $block->getViewFileUrl('Webkul_MultiQuickbooksConnect::images/loader.gif');?>
            <img id="loader-image" src="<?= /* @noEscape */ $loaderSrc ?>" />
        </div>
        <div class="wk-mu-progress-bar">
            <div class="wk-mu-progress-bar-current"></div>
        </div>
    <?php else:?>
        <div class="wk-mu-note wk-mu-box">
            <?= /* @noEscape */ __('No credit memo to export.');?>
        </div>
        <div class="wk-mu-note wk-mu-box">
            <?= /* @noEscape */ __('Finsihed Execution.');?>
        </div>
    <?php endif; ?>
</fieldset>
<script type="text/javascript">
    require(['jquery'], function ($) {
        $(document).ready(function() {
            var skipCount = 0;
            var importUrl = "<?= /* @noEscape */ $block->getUrl(
                'multiquickbooksconnect/creditmemomap/createcreditmemo'
            ); ?>";
            var total = <?= /* @noEscape */ $creditmemoCount; ?>;
            var totalCreditmemo = JSON.parse('<?= /* @noEscape */ $creditmemoList['items_json'] ?>');
            var accountId = <?= /* @noEscape */ $accountId; ?>;
            if(total > 0) {
                importCreditmemoOnQuickbooks(0);
            }
            function importCreditmemoOnQuickbooks(count)
            {
                count = count;
                $.ajax({
                    type: 'get',
                    url: importUrl,
                    async: true,
                    dataType: 'json',
                    data : { 'creditmemo_id':totalCreditmemo[count]['entity_id'], 'account_id': accountId},
                    success:function(data) {
                        if(data['error'] == 1) {
                            $(".fieldset").append($('<div />')
                                                    .addClass('message message-error error')
                                                    .text(data['msg'])
                                                );
                            skipCount++;
                        }
                        width = (100/total)*(count+1);
                        $(".wk-mu-progress-bar-current").animate({width: width+"%"},'slow', function() {
                            if(count+1 == total) {
                                finishImporting(count, skipCount);
                                $(".wk-mu-info-bar").text("<?= /* @noEscape */ __('Completed') ?>");
                            } else {
                                count++;
                                $(".wk-current").text(count);
                                importCreditmemoOnQuickbooks(count);
                            }
                        });
                    }
                });
            }
            function finishImporting(count, skipCount)
            {
                $.ajax({
                    type: 'get',
                    url: importUrl,
                    async: true,
                    dataType: 'json',
                    data : {count:count, skip:skipCount, 'creditmemo_id':0},
                    success: function(data) {
                        $(".fieldset").append(data['msg']);
                    }
                });
            }
        });
    });
</script>
